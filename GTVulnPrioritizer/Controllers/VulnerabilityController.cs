using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using MongoDB.Bson;
using MongoDB.Driver;

namespace GTVulnPrioritizer.Controllers
{

    public  class VulnerabilityController : ControllerBase
    {
        public string Index()
        {
            return "Hello World";
            //  return View();
        }
        [HttpGet(Name = "GetVulnerabilities")]
        public string GetPriorityVulnerabilities()
        {
            string apiKey = "";
            var openAIClient = new OpenAIClient(apiKey);
            string csvFilePath = "C:\\Users\\user\\Documents\\Python Scripts\\output.csv"; // Path to the CSV file
            string mongoConnectionString = ""; // MongoDB connection string
            string databaseName = "vulnerability_db";
            string collectionName = "rapidVulnerabilities";
            string prompt = "Prioritize the following vulnerabilities in order of importance from most to least important:  with the following focused on thuse that affect Windows";
            var vulnerabilities = FetchFromMongoDB(mongoConnectionString, databaseName, collectionName);
            var prioritize = new VulnerabilityPrioritizer(openAIClient);
            var priorities = prioritize.GetVulnerabilityPriority(prompt, vulnerabilities);

            Console.WriteLine(priorities.ToString()); 
            return priorities.ToString();
        }
        
      


        public IMongoCollection<BsonDocument> FetchFromMongoDB(string connectionString, string databaseName, string collectionName)
        {
            var client = new MongoClient(connectionString);
            var database = client.GetDatabase(databaseName);
            var collection = database.GetCollection<BsonDocument>(collectionName);

            return collection;
        }

    }

}
